#!/bin/bash
# GDPR Tool CLI - Unified Setup and Execution Script

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# If this is a symlink, resolve it to find the actual project directory
if [ -L "${BASH_SOURCE[0]}" ]; then
    # Get the target of the symlink
    TARGET="$(readlink "${BASH_SOURCE[0]}")"
    # If target is relative, make it absolute
    if [[ "$TARGET" != /* ]]; then
        TARGET="$(dirname "${BASH_SOURCE[0]}")/$TARGET"
    fi
    SCRIPT_DIR="$(cd "$(dirname "$TARGET")" && pwd)"
fi

BACKEND_DIR="$SCRIPT_DIR/backend"

# Function to check if we're in a virtual environment
is_venv_active() {
    [ -n "$VIRTUAL_ENV" ]
}

# Function to activate virtual environment
activate_venv() {
    if [ -f "$BACKEND_DIR/.venv/bin/activate" ]; then
        echo "üîß Activating virtual environment..."
        source "$BACKEND_DIR/.venv/bin/activate"
        return 0
    else
        echo "‚ùå Virtual environment not found at $BACKEND_DIR/.venv/bin/activate"
        return 1
    fi
}

# Function to setup virtual environment
setup_venv() {
    echo "üöÄ Setting up GDPR Tool CLI..."
    
    # Check if virtual environment exists
    if [ ! -d "$BACKEND_DIR/.venv" ]; then
        echo "üì¶ Creating virtual environment..."
        cd "$BACKEND_DIR"
        python3 -m venv .venv
        
        echo "üîß Activating virtual environment..."
        source .venv/bin/activate
        
        echo "üì• Installing dependencies..."
        pip install -r requirements.txt
        
        echo "‚úÖ Setup complete!"
    else
        echo "‚úÖ Virtual environment already exists"
    fi
}

# Function to install globally
install_global() {
    echo "üöÄ Installing GDPR Tool CLI globally..."
    
    # Check if script exists
    if [ ! -f "$SCRIPT_DIR/gdpr-cli" ]; then
        echo "‚ùå Error: gdpr-cli script not found at $SCRIPT_DIR/gdpr-cli"
        exit 1
    fi
    
    # Make script executable
    chmod +x "$SCRIPT_DIR/gdpr-cli"
    
    # Create symlink in /usr/local/bin (requires sudo)
    if command -v sudo >/dev/null 2>&1; then
        echo "üì¶ Creating global symlink..."
        sudo ln -sf "$SCRIPT_DIR/gdpr-cli" /usr/local/bin/gdpr-cli
        echo "‚úÖ CLI installed globally!"
        echo ""
        echo "üéâ You can now run 'gdpr-cli' from anywhere:"
        echo "   gdpr-cli list-products"
        echo "   gdpr-cli upload-and-process /path/to/file.txt --product \"Generic\""
    else
        echo "‚ö†Ô∏è  Sudo not available. Manual installation required:"
        echo "   sudo ln -sf $SCRIPT_DIR/gdpr-cli /usr/local/bin/gdpr-cli"
    fi
}

# Function to install for user
install_user() {
    echo "üöÄ Installing GDPR Tool CLI for current user..."
    
    # Check if script exists
    if [ ! -f "$SCRIPT_DIR/gdpr-cli" ]; then
        echo "‚ùå Error: gdpr-cli script not found at $SCRIPT_DIR/gdpr-cli"
        exit 1
    fi
    
    # Make script executable
    chmod +x "$SCRIPT_DIR/gdpr-cli"
    
    # Create user bin directory if it doesn't exist
    USER_BIN="$HOME/.local/bin"
    mkdir -p "$USER_BIN"
    
    # Create symlink
    echo "üì¶ Creating user symlink..."
    ln -sf "$SCRIPT_DIR/gdpr-cli" "$USER_BIN/gdpr-cli"
    
    # Add to PATH if not already there
    if ! echo "$PATH" | grep -q "$USER_BIN"; then
        echo "üîß Adding $USER_BIN to PATH..."
        
        # Detect shell and add to appropriate profile
        if [ -n "$ZSH_VERSION" ]; then
            PROFILE="$HOME/.zshrc"
        elif [ -n "$BASH_VERSION" ]; then
            PROFILE="$HOME/.bashrc"
        else
            PROFILE="$HOME/.profile"
        fi
        
        echo "" >> "$PROFILE"
        echo "# GDPR Tool CLI" >> "$PROFILE"
        echo "export PATH=\"\$HOME/.local/bin:\$PATH\"" >> "$PROFILE"
        
        echo "‚úÖ Added to $PROFILE"
        echo "üîÑ Please run 'source $PROFILE' or restart your terminal"
    fi
    
    echo "‚úÖ CLI installed for user!"
    echo ""
    echo "üéâ You can now run 'gdpr-cli' from anywhere:"
    echo "   gdpr-cli list-products"
    echo "   gdpr-cli upload-and-process /path/to/file.txt --product \"Generic\""
    echo ""
    echo "Note: You may need to restart your terminal or run 'source ~/.bashrc'"
}

# Function to check if CLI is installed globally
is_cli_installed() {
    command -v gdpr-cli >/dev/null 2>&1
}

# Function to auto-install CLI
auto_install_cli() {
    echo "üöÄ GDPR Tool CLI - First Time Setup"
    echo "===================================="
    echo ""
    echo "This appears to be the first time running the CLI."
    echo "Setting up automatic installation..."
    echo ""
    
    # Try to install globally first
    if [ "$EUID" -eq 0 ] || sudo -n true 2>/dev/null; then
        echo "üì¶ Installing globally for all users..."
        install_global
        echo ""
        echo "‚úÖ CLI installed globally! You can now run 'gdpr-cli' from anywhere."
    else
        echo "üì¶ Installing for current user only..."
        install_user
        echo ""
        echo "‚úÖ CLI installed for current user! You can now run 'gdpr-cli' from anywhere."
        echo "   Note: You may need to restart your terminal or run 'source ~/.bashrc'"
    fi
    
    echo ""
    echo "üéâ Setup complete! Try running: gdpr-cli help"
    exit 0
}

# Function to show help
show_help() {
    echo "GDPR Tool CLI - Auto-Installing Command Line Interface"
    echo ""
    echo "Usage:"
    echo "  gdpr-cli [command] [options]     # Run CLI commands"
    echo "  gdpr-cli help                    # Show this help"
    echo ""
    echo "CLI Commands:"
    echo "  mask <file> --product <name>     # Mask a file"
    echo "  list-products                    # List available products"
    echo "  list-files                       # List uploaded files"
    echo ""
    echo "Examples:"
    echo "  gdpr-cli list-products"
    echo "  gdpr-cli mask /path/to/file.txt --product \"Generic\""
}

# Handle special commands
case "$1" in
    "help"|"--help"|"-h")
        show_help
        exit 0
        ;;
esac

# Check if this is the first time running the CLI
if [ ! -L "${BASH_SOURCE[0]}" ] && [ ! -f "/usr/local/bin/gdpr-cli" ] && [ ! -f "$HOME/.local/bin/gdpr-cli" ]; then
    # This is the original script, not a symlink, and CLI is not installed
    auto_install_cli
fi

# Change to backend directory
cd "$BACKEND_DIR"

# Check if virtual environment is already active
if ! is_venv_active; then
    # Try to activate virtual environment
    if ! activate_venv; then
        echo "‚ùå Error: Virtual environment not found or failed to activate"
        echo "   The CLI will auto-setup on first run, but the virtual environment is missing"
        exit 1
    fi
else
    echo "‚úÖ Virtual environment already active: $VIRTUAL_ENV"
fi

# Run the CLI
python3 cli.py "$@"
